<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shimul_BG-Remover</title>
  <link rel="shortcut icon" href="logo.png" type="image/x-icon">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons (optional, for icons like your screenshot) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
</head>

<body class="bg-light">
  <main class="container py-5">

    <!-- Header -->
    
    <div class="text-center mb-4">
      <div class="d-inline-flex align-items-center justify-content-center bg-primary rounded-4 shadow-sm mb-3"
        style="width:48px;height:48px;">
        <img src="logo.png" alt="logo" style="vertical-align: middle;width: -webkit-fill-available;">
      </div>
    
      <h1 class="fw-bold display-5 mb-2">Background Remover</h1>
      <p class="text-secondary mb-0">
        Remove backgrounds from your images instantly with AI-powered technology. Fast,<br>
        free, and completely private.
      </p>
    </div>

    <!-- UPLOAD SCREEN -->
    <section id="uploadScreen">
      <div class="row justify-content-center">
        <div class="col-12 col-lg-8">
          <div class="card border-0 shadow-lg rounded-5">
            <div class="card-body p-5 text-center">

              <div class="d-inline-flex align-items-center justify-content-center bg-primary rounded-circle shadow mb-3"
                style="width:76px;height:76px;">
                <i class="bi bi-upload text-white fs-2"></i>
              </div>

              <h2 class="fw-bold mb-2">Upload Your Image</h2>
              <p class="text-secondary mb-4">Drag and drop your image here, or click to browse</p>

              <div id="dropzone" class="border border-2 border-primary-subtle rounded-4 p-4 bg-primary bg-opacity-10"
                role="button" tabindex="0" aria-label="Upload image">
                <div class="mb-3">
                  <label for="fileInput" class="btn btn-primary btn-lg px-4">
                    <i class="bi bi-upload me-2"></i>Choose Image
                  </label>
                  <input id="fileInput" class="d-none" type="file" accept="image/*">
                </div>
                <small class="text-secondary">Supports JPG, PNG, and WebP formats</small>

                <div class="mt-3">
                  <div id="statusUpload" class="text-secondary fw-semibold small"></div>
                  <div class="progress mt-2" style="height:10px;">
                    <div id="barUpload" class="progress-bar" style="width:0%"></div>
                  </div>
                </div>
              </div>

              <div class="mt-3 small text-secondary">
                First run can take longer because the browser fetches and caches model/WASM assets.
              </div>

            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- RESULT SCREEN -->
    <section id="resultScreen" class="d-none">

      <!-- Top buttons -->
      <div class="d-flex justify-content-center gap-2 flex-wrap my-4">
        <button id="newBtn" class="btn btn-outline-secondary px-4">
          <i class="bi bi-x-lg me-2"></i>New Image
        </button>

        <a id="downloadBtn" class="btn btn-primary px-4" href="#" download="background-removed.png">
          <i class="bi bi-download me-2"></i>Download Image
        </a>
      </div>

      <!-- Export controls -->
      <div class="d-flex justify-content-center gap-2 flex-wrap align-items-center mb-3">
        <select id="bgMode" class="form-select w-auto">
          <option value="transparent">Transparent (PNG)</option>
          <option value="white">White</option>
          <option value="black">Black</option>
          <option value="custom">Custom</option>
        </select>

        <input id="bgColor" type="color" class="form-control form-control-color d-none" value="#ffffff"
          title="Pick background color">

        <div id="qualityWrap" class="d-none d-flex align-items-center gap-2">
          <input id="jpgQuality" type="range" class="form-range" min="0.6" max="1" step="0.05" value="0.9"
            style="width:180px;">
          <span id="qLabel" class="small text-secondary fw-semibold">0.90</span>
        </div>
      </div>

      <!-- Two panels -->
      <div class="row g-4">
        <div class="col-12 col-lg-6">
          <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
            <div class="bg-dark text-white fw-bold px-3 py-2 small">Original</div>
            <div class="p-3">
              <div class="rounded-3 overflow-hidden border">
                <img id="imgOriginal" class="img-fluid w-100" alt="Original image">
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-6">
          <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
            <div class="bg-primary text-white fw-bold px-3 py-2 small">Background Removed</div>
            <div class="p-3">
              <!-- checkerboard background (inline style only) -->
              <div id="resultFrame" class="rounded-3 overflow-hidden border" style="background-image:
                      linear-gradient(45deg, #cbd5e1 25%, transparent 25%),
                      linear-gradient(-45deg, #cbd5e1 25%, transparent 25%),
                      linear-gradient(45deg, transparent 75%, #cbd5e1 75%),
                      linear-gradient(-45deg, transparent 75%, #cbd5e1 75%);
                      background-size: 22px 22px;
                      background-position: 0 0, 0 11px, 11px -11px, -11px 0px;">
                <img id="imgResult" class="img-fluid w-100" alt="Background removed image">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- status -->
      <div class="text-center mt-3">
        <div id="statusResult" class="text-secondary fw-semibold small"></div>
        <div class="progress mt-2 mx-auto" style="height:10px; max-width: 520px;">
          <div id="barResult" class="progress-bar" style="width:0%"></div>
        </div>
      </div>

    </section>

  </main>

  <script type="module">
    // Named export (fixes: "no default export")
    import { removeBackground } from "https://esm.sh/@imgly/background-removal@1.5.8";

    // Elements
    const uploadScreen = document.getElementById("uploadScreen");
    const resultScreen = document.getElementById("resultScreen");
    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("fileInput");

    const statusUpload = document.getElementById("statusUpload");
    const barUpload = document.getElementById("barUpload");

    const statusResult = document.getElementById("statusResult");
    const barResult = document.getElementById("barResult");

    const imgOriginal = document.getElementById("imgOriginal");
    const imgResult = document.getElementById("imgResult");

    const newBtn = document.getElementById("newBtn");
    const downloadBtn = document.getElementById("downloadBtn");

    const bgMode = document.getElementById("bgMode");
    const bgColor = document.getElementById("bgColor");
    const jpgQuality = document.getElementById("jpgQuality");
    const qLabel = document.getElementById("qLabel");
    const qualityWrap = document.getElementById("qualityWrap");
    const resultFrame = document.getElementById("resultFrame");

    // State
    let originalBlob = null;
    let resultPngBlob = null;
    let originalUrl = null;
    let resultUrl = null;
    let downloadUrl = null;

    const setText = (el, msg) => el.textContent = msg || "";
    const setProgress = (el, pct) => el.style.width = `${Math.max(0, Math.min(100, pct))}%`;
    const revoke = (u) => { if (u) URL.revokeObjectURL(u); };

    function resetAll() {
      originalBlob = null;
      resultPngBlob = null;

      revoke(originalUrl); originalUrl = null;
      revoke(resultUrl); resultUrl = null;
      revoke(downloadUrl); downloadUrl = null;

      imgOriginal.removeAttribute("src");
      imgResult.removeAttribute("src");

      downloadBtn.href = "#";
      downloadBtn.download = "background-removed.png";

      bgMode.value = "transparent";
      bgColor.classList.add("d-none");
      qualityWrap.classList.add("d-none");
      qLabel.textContent = Number(jpgQuality.value).toFixed(2);

      // keep checkerboard visible; JPG mode will still look fine
      setText(statusUpload, "");
      setProgress(barUpload, 0);
      setText(statusResult, "");
      setProgress(barResult, 0);

      uploadScreen.classList.remove("d-none");
      resultScreen.classList.add("d-none");
      fileInput.value = "";
    }

    resetAll();

    // Drag & drop visuals (Bootstrap only – we just toggle border class)
    ["dragenter", "dragover"].forEach(evt => {
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault(); e.stopPropagation();
        dropzone.classList.add("border-primary");
      });
    });

    ["dragleave", "drop"].forEach(evt => {
      dropzone.addEventListener(evt, (e) => {
        e.preventDefault(); e.stopPropagation();
        dropzone.classList.remove("border-primary");
      });
    });

    dropzone.addEventListener("drop", (e) => {
      const f = e.dataTransfer.files?.[0];
      if (f) handleFile(f);
    });

    // Click empty area to browse (avoid stealing clicks on controls)
    dropzone.addEventListener("click", (e) => {
      if (e.target.closest("button,a,label,select,input")) return;
      fileInput.click();
    });

    dropzone.addEventListener("keydown", (e) => {
      if (e.key !== "Enter" && e.key !== " ") return;
      if (e.target.closest("button,a,label,select,input")) return;
      fileInput.click();
    });

    fileInput.addEventListener("change", () => {
      const f = fileInput.files?.[0];
      if (f) handleFile(f);
    });

    function bgHex() {
      if (bgMode.value === "white") return "#ffffff";
      if (bgMode.value === "black") return "#000000";
      if (bgMode.value === "custom") return bgColor.value || "#ffffff";
      return null; // transparent
    }

    async function blobToBitmap(blob) {
      if ("createImageBitmap" in window) return await createImageBitmap(blob);
      return await new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = URL.createObjectURL(blob);
      });
    }

    async function compositeToJpeg(pngBlob, background, quality = 0.9) {
      const bmp = await blobToBitmap(pngBlob);
      const canvas = document.createElement("canvas");
      canvas.width = bmp.width;
      canvas.height = bmp.height;

      const ctx = canvas.getContext("2d", { alpha: false });
      ctx.fillStyle = background;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(bmp, 0, 0);

      const jpgBlob = await new Promise((resolve) => {
        canvas.toBlob((b) => resolve(b), "image/jpeg", quality);
      });

      if (bmp && typeof bmp.close === "function") bmp.close();
      return jpgBlob;
    }

    async function rebuildDownload() {
      if (!resultPngBlob) return;

      // UI toggles
      const mode = bgMode.value;
      if (mode === "custom") bgColor.classList.remove("d-none");
      else bgColor.classList.add("d-none");

      if (mode === "transparent") {
        qualityWrap.classList.add("d-none");
        downloadBtn.download = "background-removed.png";

        revoke(downloadUrl);
        downloadUrl = URL.createObjectURL(resultPngBlob);
        downloadBtn.href = downloadUrl;

        setText(statusResult, "Done. Download PNG (transparent).");
        return;
      }

      qualityWrap.classList.remove("d-none");
      qLabel.textContent = Number(jpgQuality.value).toFixed(2);

      setText(statusResult, "Preparing JPG…");
      const jpgBlob = await compositeToJpeg(resultPngBlob, bgHex(), Number(jpgQuality.value || 0.9));

      revoke(downloadUrl);
      downloadUrl = URL.createObjectURL(jpgBlob);
      downloadBtn.href = downloadUrl;
      downloadBtn.download = "background-removed.jpg";

      setText(statusResult, "Done. Download JPG (with background).");
    }

    bgMode.addEventListener("change", () => rebuildDownload().catch(console.error));
    bgColor.addEventListener("input", () => rebuildDownload().catch(console.error));
    jpgQuality.addEventListener("input", () => rebuildDownload().catch(console.error));

    newBtn.addEventListener("click", resetAll);

    async function handleFile(file) {
      if (!file.type.startsWith("image/")) {
        setText(statusUpload, "Please select an image file.");
        return;
      }

      originalBlob = file;

      revoke(originalUrl);
      originalUrl = URL.createObjectURL(file);
      imgOriginal.src = originalUrl;

      setText(statusUpload, "Processing…");
      setProgress(barUpload, 20);

      // Switch screens like your screenshot flow
      uploadScreen.classList.add("d-none");
      resultScreen.classList.remove("d-none");

      setText(statusResult, "Removing background…");
      setProgress(barResult, 15);

      try {
        // Remove background => transparent PNG Blob
        resultPngBlob = await removeBackground(originalBlob);

        revoke(resultUrl);
        resultUrl = URL.createObjectURL(resultPngBlob);
        imgResult.src = resultUrl;

        setProgress(barResult, 100);
        await rebuildDownload();
      } catch (err) {
        console.error(err);
        setText(statusResult, "Failed. Check DevTools Console for details.");
        setProgress(barResult, 0);
      }
    }
  </script>
</body>

</html>